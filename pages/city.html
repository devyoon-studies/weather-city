<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>서울 날씨 - 강남구</title>
        <link rel="stylesheet" href="../css/common.css" />
    </head>
    <body>
        <div class="container">
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="center-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">날씨 정보를 불러오는 중...</div>
                </div>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <div class="center-content">
                    <div class="error-text">날씨 정보를 불러오는데 실패했습니다.</div>
                    <button class="retry-button" onclick="requestWeatherData()">다시 시도</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content" id="content" style="display: none;">
                <div class="scroll-container">
                <!-- Header -->
                <div class="header">
                    <h1 class="city-name" id="cityName">강남구</h1>
                    <p class="city-name-en" id="cityNameEn">Gangnam-gu</p>
                </div>

                <!-- Current Weather -->
                <div class="current-weather-section">
                    <div class="temperature-container">
                        <div class="current-temperature" id="currentTemp">
                            33°
                        </div>
                        <div class="weather-info">
                            <div
                                class="weather-description"
                                id="weatherDescription"
                            >
                                맑음
                            </div>
                            <div class="weather-icon" id="weatherIcon">☀️</div>
                        </div>
                    </div>

                    <!-- Min/Max Temperature -->
                    <div class="min-max-container">
                        <div class="min-max-text" id="minMaxText">
                            최고 33° / 최저 26°
                        </div>
                    </div>
                </div>

                <!-- Additional Weather Details -->
                <div class="details-section">
                    <h2 class="section-title">상세 정보</h2>

                    <div class="detail-row">
                        <span class="detail-label">체감온도</span>
                        <span class="detail-value" id="feelsLike">40°C</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">습도</span>
                        <span class="detail-value" id="humidity">59%</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">기압</span>
                        <span class="detail-value" id="pressure">1011 hPa</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">풍속</span>
                        <span class="detail-value" id="windSpeed">3.2 m/s</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">가시거리</span>
                        <span class="detail-value" id="visibility"
                            >10.0 km</span
                        >
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* 로딩 상태 스타일 */
            .loading-state, .error-state {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #007AFF;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .retry-button {
                background: #007AFF;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                margin-top: 16px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .retry-button:hover {
                background: #0056CC;
            }

            /* 날씨 아이콘 스타일 개선 */
            .weather-icon {
                font-size: 24px !important;
                margin-top: 8px !important;
            }

            /* 온도에 따른 색상 */
            .temp-hot { color: #ff6b6b; }
            .temp-warm { color: #ffa726; }
            .temp-cool { color: #42a5f5; }
            .temp-cold { color: #5c6bc0; }
        </style>

        <script>
            // 페이지 상태 관리
            let currentWeatherData = null;
            let isLoading = true;

            // 페이지 초기화
            document.addEventListener("DOMContentLoaded", function () {
                console.log("City weather page loaded, waiting for data...");
                showLoading();
                
                // React Native에게 데이터 요청
                requestWeatherData();
            });

            // 로딩 상태 표시
            function showLoading() {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                isLoading = true;
            }

            // 에러 상태 표시
            function showError() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                isLoading = false;
            }

            // 컨텐츠 표시
            function showContent() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                isLoading = false;
            }

            // React Native에 날씨 데이터 요청
            function requestWeatherData() {
                console.log("Requesting weather data from React Native...");
                showLoading();
                
                // React Native에 메시지 전송
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'REQUEST_WEATHER_DATA'
                    }));
                } else {
                    console.log("ReactNativeWebView not available, using sample data");
                    // 웹 브라우저에서 테스트할 때 샘플 데이터 사용
                    setTimeout(() => {
                        const sampleData = {
                            cityName: '강남구',
                            cityNameEn: 'Gangnam-gu',
                            currentWeather: {
                                main: {
                                    temp: 33.24,
                                    feels_like: 39.77,
                                    humidity: 59,
                                    pressure: 1011
                                },
                                weather: [{
                                    description: '맑음',
                                    icon: '01d'
                                }],
                                wind: {
                                    speed: 3.2
                                },
                                visibility: 10000
                            },
                            todayMinMax: {
                                min: 26.38,
                                max: 33.24
                            }
                        };
                        handleWeatherDataReceived(sampleData);
                    }, 1000);
                }
            }

            // 날씨 아이콘 매핑
            function getWeatherIcon(iconCode) {
                const iconMap = {
                    '01d': '☀️', '01n': '🌙',
                    '02d': '⛅', '02n': '☁️',
                    '03d': '☁️', '03n': '☁️',
                    '04d': '☁️', '04n': '☁️',
                    '09d': '🌧️', '09n': '🌧️',
                    '10d': '🌦️', '10n': '🌧️',
                    '11d': '⛈️', '11n': '⛈️',
                    '13d': '❄️', '13n': '❄️',
                    '50d': '🌫️', '50n': '🌫️'
                };
                return iconMap[iconCode] || '🌤️';
            }

            // 온도에 따른 클래스 반환
            function getTemperatureClass(temp) {
                if (temp >= 30) return 'temp-hot';
                if (temp >= 20) return 'temp-warm';
                if (temp >= 10) return 'temp-cool';
                return 'temp-cold';
            }

            // React Native에서 날씨 데이터를 받았을 때 처리
            function handleWeatherDataReceived(data) {
                console.log("Weather data received:", data);
                currentWeatherData = data;

                try {
                    updateUI(data);
                    showContent();
                } catch (error) {
                    console.error("Error updating UI:", error);
                    showError();
                }
            }

            // UI 업데이트
            function updateUI(data) {
                // 도시 정보 업데이트
                if (data.cityName) {
                    document.getElementById("cityName").textContent = data.cityName;
                    document.title = `서울 날씨 - ${data.cityName}`;
                }
                if (data.cityNameEn) {
                    document.getElementById("cityNameEn").textContent = data.cityNameEn;
                }

                const currentWeather = data.currentWeather;
                if (currentWeather) {
                    // 현재 온도
                    if (currentWeather.main && currentWeather.main.temp) {
                        const temp = Math.round(currentWeather.main.temp);
                        const tempElement = document.getElementById("currentTemp");
                        tempElement.textContent = temp + "°";
                        tempElement.className = `current-temperature ${getTemperatureClass(temp)}`;
                    }

                    // 날씨 설명 및 아이콘
                    if (currentWeather.weather && currentWeather.weather[0]) {
                        const weather = currentWeather.weather[0];
                        document.getElementById("weatherDescription").textContent = weather.description || '';
                        document.getElementById("weatherIcon").textContent = getWeatherIcon(weather.icon);
                    }

                    // 최고/최저 온도
                    if (data.todayMinMax) {
                        const minTemp = Math.round(data.todayMinMax.min);
                        const maxTemp = Math.round(data.todayMinMax.max);
                        document.getElementById("minMaxText").textContent = `최고 ${maxTemp}° / 최저 ${minTemp}°`;
                    }

                    // 상세 정보
                    if (currentWeather.main) {
                        if (currentWeather.main.feels_like) {
                            document.getElementById("feelsLike").textContent = 
                                Math.round(currentWeather.main.feels_like) + "°C";
                        }
                        if (currentWeather.main.humidity) {
                            document.getElementById("humidity").textContent = 
                                currentWeather.main.humidity + "%";
                        }
                        if (currentWeather.main.pressure) {
                            document.getElementById("pressure").textContent = 
                                currentWeather.main.pressure + " hPa";
                        }
                    }

                    if (currentWeather.wind && currentWeather.wind.speed) {
                        document.getElementById("windSpeed").textContent = 
                            currentWeather.wind.speed + " m/s";
                    }

                    if (currentWeather.visibility) {
                        document.getElementById("visibility").textContent = 
                            (currentWeather.visibility / 1000).toFixed(1) + " km";
                    }
                }
            }

            // React Native WebView 메시지 리스너
            window.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("Received message:", data);
                    
                    switch(data.type) {
                        case 'WEATHER_DATA':
                            handleWeatherDataReceived(data.payload);
                            break;
                        case 'ERROR':
                            console.error("Error from React Native:", data.payload);
                            showError();
                            break;
                        default:
                            console.log("Unknown message type:", data.type);
                    }
                } catch (error) {
                    console.error("Error parsing message:", error);
                }
            });

            // 전역 함수들 (backward compatibility)
            window.updateWeatherData = function(newData) {
                console.log("updateWeatherData called with:", newData);
                handleWeatherDataReceived({
                    currentWeather: {
                        main: {
                            temp: newData.temp,
                            feels_like: newData.feelsLike,
                            humidity: newData.humidity,
                            pressure: newData.pressure
                        },
                        weather: [{
                            description: newData.description,
                            icon: newData.icon
                        }],
                        wind: {
                            speed: newData.windSpeed
                        },
                        visibility: newData.visibility * 1000
                    },
                    todayMinMax: {
                        min: newData.min,
                        max: newData.max
                    }
                });
            };

            window.updateCityInfo = function(cityName, cityNameEn) {
                console.log("updateCityInfo called:", cityName, cityNameEn);
                document.getElementById("cityName").textContent = cityName;
                document.getElementById("cityNameEn").textContent = cityNameEn;
                document.title = `서울 날씨 - ${cityName}`;
            };

            // 에러 시 React Native에 재시도 요청
            window.retryWeatherData = requestWeatherData;
        </script>
    </body>
</html>
