<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ì„œìš¸ ë‚ ì”¨ - ê°•ë‚¨êµ¬</title>
        <link rel="stylesheet" href="../css/common.css" />
    </head>
    <body>
        <div class="container">
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="center-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <div class="center-content">
                    <div class="error-text">ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
                    <button class="retry-button" onclick="requestWeatherData()">ë‹¤ì‹œ ì‹œë„</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content" id="content" style="display: none;">
                <div class="scroll-container">
                <!-- Header -->
                <div class="header">
                    <h1 class="city-name" id="cityName">ê°•ë‚¨êµ¬</h1>
                    <p class="city-name-en" id="cityNameEn">Gangnam-gu</p>
                </div>

                <!-- Current Weather -->
                <div class="current-weather-section">
                    <div class="temperature-container">
                        <div class="current-temperature" id="currentTemp">
                            33Â°
                        </div>
                        <div class="weather-info">
                            <div
                                class="weather-description"
                                id="weatherDescription"
                            >
                                ë§‘ìŒ
                            </div>
                            <div class="weather-icon" id="weatherIcon">â˜€ï¸</div>
                        </div>
                    </div>

                    <!-- Min/Max Temperature -->
                    <div class="min-max-container">
                        <div class="min-max-text" id="minMaxText">
                            ìµœê³  33Â° / ìµœì € 26Â°
                        </div>
                    </div>
                </div>

                <!-- Additional Weather Details -->
                <div class="details-section">
                    <h2 class="section-title">ìƒì„¸ ì •ë³´</h2>

                    <div class="detail-row">
                        <span class="detail-label">ì²´ê°ì˜¨ë„</span>
                        <span class="detail-value" id="feelsLike">40Â°C</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">ìŠµë„</span>
                        <span class="detail-value" id="humidity">59%</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">ê¸°ì••</span>
                        <span class="detail-value" id="pressure">1011 hPa</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">í’ì†</span>
                        <span class="detail-value" id="windSpeed">3.2 m/s</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">ê°€ì‹œê±°ë¦¬</span>
                        <span class="detail-value" id="visibility"
                            >10.0 km</span
                        >
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* ë¡œë”© ìƒíƒœ ìŠ¤íƒ€ì¼ */
            .loading-state, .error-state {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #007AFF;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .retry-button {
                background: #007AFF;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                margin-top: 16px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .retry-button:hover {
                background: #0056CC;
            }

            /* ë‚ ì”¨ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ ê°œì„  */
            .weather-icon {
                font-size: 24px !important;
                margin-top: 8px !important;
            }

            /* ì˜¨ë„ì— ë”°ë¥¸ ìƒ‰ìƒ */
            .temp-hot { color: #ff6b6b; }
            .temp-warm { color: #ffa726; }
            .temp-cool { color: #42a5f5; }
            .temp-cold { color: #5c6bc0; }
        </style>

        <script>
            // í˜ì´ì§€ ìƒíƒœ ê´€ë¦¬
            let currentWeatherData = null;
            let isLoading = true;

            // í˜ì´ì§€ ì´ˆê¸°í™”
            document.addEventListener("DOMContentLoaded", function () {
                console.log("City weather page loaded, waiting for data...");
                showLoading();
                
                // React Nativeì—ê²Œ ë°ì´í„° ìš”ì²­
                requestWeatherData();
            });

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            function showLoading() {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                isLoading = true;
            }

            // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
            function showError() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                isLoading = false;
            }

            // ì»¨í…ì¸  í‘œì‹œ
            function showContent() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                isLoading = false;
            }

            // React Nativeì— ë‚ ì”¨ ë°ì´í„° ìš”ì²­
            function requestWeatherData() {
                console.log("Requesting weather data from React Native...");
                showLoading();
                
                // React Nativeì— ë©”ì‹œì§€ ì „ì†¡
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'REQUEST_WEATHER_DATA'
                    }));
                } else {
                    console.log("ReactNativeWebView not available, using sample data");
                    // ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸í•  ë•Œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                    setTimeout(() => {
                        const sampleData = {
                            cityName: 'ê°•ë‚¨êµ¬',
                            cityNameEn: 'Gangnam-gu',
                            currentWeather: {
                                main: {
                                    temp: 33.24,
                                    feels_like: 39.77,
                                    humidity: 59,
                                    pressure: 1011
                                },
                                weather: [{
                                    description: 'ë§‘ìŒ',
                                    icon: '01d'
                                }],
                                wind: {
                                    speed: 3.2
                                },
                                visibility: 10000
                            },
                            todayMinMax: {
                                min: 26.38,
                                max: 33.24
                            }
                        };
                        handleWeatherDataReceived(sampleData);
                    }, 1000);
                }
            }

            // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
            function getWeatherIcon(iconCode) {
                const iconMap = {
                    '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
                    '02d': 'â›…', '02n': 'â˜ï¸',
                    '03d': 'â˜ï¸', '03n': 'â˜ï¸',
                    '04d': 'â˜ï¸', '04n': 'â˜ï¸',
                    '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
                    '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
                    '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
                    '13d': 'â„ï¸', '13n': 'â„ï¸',
                    '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
                };
                return iconMap[iconCode] || 'ğŸŒ¤ï¸';
            }

            // ì˜¨ë„ì— ë”°ë¥¸ í´ë˜ìŠ¤ ë°˜í™˜
            function getTemperatureClass(temp) {
                if (temp >= 30) return 'temp-hot';
                if (temp >= 20) return 'temp-warm';
                if (temp >= 10) return 'temp-cool';
                return 'temp-cold';
            }

            // React Nativeì—ì„œ ë‚ ì”¨ ë°ì´í„°ë¥¼ ë°›ì•˜ì„ ë•Œ ì²˜ë¦¬
            function handleWeatherDataReceived(data) {
                console.log("Weather data received:", data);
                currentWeatherData = data;

                try {
                    updateUI(data);
                    showContent();
                } catch (error) {
                    console.error("Error updating UI:", error);
                    showError();
                }
            }

            // UI ì—…ë°ì´íŠ¸
            function updateUI(data) {
                // ë„ì‹œ ì •ë³´ ì—…ë°ì´íŠ¸
                if (data.cityName) {
                    document.getElementById("cityName").textContent = data.cityName;
                    document.title = `ì„œìš¸ ë‚ ì”¨ - ${data.cityName}`;
                }
                if (data.cityNameEn) {
                    document.getElementById("cityNameEn").textContent = data.cityNameEn;
                }

                const currentWeather = data.currentWeather;
                if (currentWeather) {
                    // í˜„ì¬ ì˜¨ë„
                    if (currentWeather.main && currentWeather.main.temp) {
                        const temp = Math.round(currentWeather.main.temp);
                        const tempElement = document.getElementById("currentTemp");
                        tempElement.textContent = temp + "Â°";
                        tempElement.className = `current-temperature ${getTemperatureClass(temp)}`;
                    }

                    // ë‚ ì”¨ ì„¤ëª… ë° ì•„ì´ì½˜
                    if (currentWeather.weather && currentWeather.weather[0]) {
                        const weather = currentWeather.weather[0];
                        document.getElementById("weatherDescription").textContent = weather.description || '';
                        document.getElementById("weatherIcon").textContent = getWeatherIcon(weather.icon);
                    }

                    // ìµœê³ /ìµœì € ì˜¨ë„
                    if (data.todayMinMax) {
                        const minTemp = Math.round(data.todayMinMax.min);
                        const maxTemp = Math.round(data.todayMinMax.max);
                        document.getElementById("minMaxText").textContent = `ìµœê³  ${maxTemp}Â° / ìµœì € ${minTemp}Â°`;
                    }

                    // ìƒì„¸ ì •ë³´
                    if (currentWeather.main) {
                        if (currentWeather.main.feels_like) {
                            document.getElementById("feelsLike").textContent = 
                                Math.round(currentWeather.main.feels_like) + "Â°C";
                        }
                        if (currentWeather.main.humidity) {
                            document.getElementById("humidity").textContent = 
                                currentWeather.main.humidity + "%";
                        }
                        if (currentWeather.main.pressure) {
                            document.getElementById("pressure").textContent = 
                                currentWeather.main.pressure + " hPa";
                        }
                    }

                    if (currentWeather.wind && currentWeather.wind.speed) {
                        document.getElementById("windSpeed").textContent = 
                            currentWeather.wind.speed + " m/s";
                    }

                    if (currentWeather.visibility) {
                        document.getElementById("visibility").textContent = 
                            (currentWeather.visibility / 1000).toFixed(1) + " km";
                    }
                }
            }

            // React Native WebView ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("Received message:", data);
                    
                    switch(data.type) {
                        case 'WEATHER_DATA':
                            handleWeatherDataReceived(data.payload);
                            break;
                        case 'ERROR':
                            console.error("Error from React Native:", data.payload);
                            showError();
                            break;
                        default:
                            console.log("Unknown message type:", data.type);
                    }
                } catch (error) {
                    console.error("Error parsing message:", error);
                }
            });

            // ì „ì—­ í•¨ìˆ˜ë“¤ (backward compatibility)
            window.updateWeatherData = function(newData) {
                console.log("updateWeatherData called with:", newData);
                handleWeatherDataReceived({
                    currentWeather: {
                        main: {
                            temp: newData.temp,
                            feels_like: newData.feelsLike,
                            humidity: newData.humidity,
                            pressure: newData.pressure
                        },
                        weather: [{
                            description: newData.description,
                            icon: newData.icon
                        }],
                        wind: {
                            speed: newData.windSpeed
                        },
                        visibility: newData.visibility * 1000
                    },
                    todayMinMax: {
                        min: newData.min,
                        max: newData.max
                    }
                });
            };

            window.updateCityInfo = function(cityName, cityNameEn) {
                console.log("updateCityInfo called:", cityName, cityNameEn);
                document.getElementById("cityName").textContent = cityName;
                document.getElementById("cityNameEn").textContent = cityNameEn;
                document.title = `ì„œìš¸ ë‚ ì”¨ - ${cityName}`;
            };

            // ì—ëŸ¬ ì‹œ React Nativeì— ì¬ì‹œë„ ìš”ì²­
            window.retryWeatherData = requestWeatherData;
        </script>
    </body>
</html>
